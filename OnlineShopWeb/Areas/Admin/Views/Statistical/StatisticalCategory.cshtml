@{
    ViewBag.Title = "StatisticalCategory";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
}
<h2 style="font-size: 1.5rem;">Thống Kê</h2>
<div class="row d-flex justify-content-between mb-4">
    <style>
        .small-card {
            max-height: 100px;
            padding: 5px;
            font-size: 0.8rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-radius: 5px;
            transition: transform 0.2s;
        }

            .small-card:hover {
                transform: scale(1.02);
            }

        .card-header {
            display: flex;
            align-items: center;
        }

            .card-header i {
                margin-right: 5px;
            }

        .chart-container {
            margin-top: 20px;
            margin-bottom: 20px;
        }

        h4 {
            margin-bottom: 8px;
        }

        select {
            margin-bottom: 10px;
        }
    </style>

    <div class="col-md-3 col-sm-6 mb-2">
        <div class="card text-white bg-info mb-3 small-card">
            <div class="card-header">
                <i class="fas fa-box"></i> Thống kê sản phẩm
            </div>
            <div class="card-body">
                <h5 class="card-title">@ViewBag.CountProduct</h5>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-2">
        <div class="card text-white bg-success mb-3 small-card">
            <div class="card-header">
                <i class="fas fa-shopping-cart"></i> Thống kê đơn hàng
            </div>
            <div class="card-body">
                <h5 class="card-title">@ViewBag.CountOrder</h5>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-2">
        <div class="card text-white bg-warning mb-3 small-card">
            <div class="card-header">
                <i class="fas fa-tags"></i> Thống kê danh mục
            </div>
            <div class="card-body">
                <h5 class="card-title">@ViewBag.CountCategory</h5>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-2">
        <div class="card text-white bg-danger mb-3 small-card">
            <div class="card-header">
                <i class="fas fa-users"></i> Thống kê user
            </div>
            <div class="card-body">
                <h5 class="card-title">@ViewBag.CountUser</h5>
            </div>
        </div>
    </div>
</div>

<div class="chart-container">
    <h4>5 Sản Phẩm Được Mua Nhiều Nhất</h4>
    <div id="productChart" style="height: 180px;"></div>
</div>

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/morris.js/0.5.1/morris.css">
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/raphael/2.1.0/raphael-min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/morris.js/0.5.1/morris.min.js"></script>

<script>
    $(document).ready(function () {
        fetchTop5Products();
    });

    function fetchTop5Products() {
        $.ajax({
            url: '/admin/statistical/top5products',
            type: 'GET',
            dataType: 'json',
            success: function (data) {
                var chartData = [];
                $.each(data, function (index, product) {
                    chartData.push({ label: product.Name, value: product.TotalQuantity });
                });

                if (chartData.length > 0) {
                    new Morris.Bar({
                        element: 'productChart',
                        data: chartData,
                        xkey: 'label',
                        ykeys: ['value'],
                        labels: ['Số lượng mua'],
                        barColors: ['#00a65a'],
                        xLabelAngle: 0,
                        hideHover: 'auto'
                    });
                } else {
                    $('#productChart').text('Không có dữ liệu để hiển thị.');
                }
            },
            error: function (error) {
                console.error("Lỗi khi tải dữ liệu:", error);
                $('#productChart').text('Có lỗi xảy ra trong quá trình tải dữ liệu.');
            }
        });
    }
</script>

<div class="chart-container">
    <h4>Doanh thu và Lợi nhuận</h4>
    <label for="yearSelect">Chọn Năm:</label>
    <select id="yearSelect">
        <!-- Các năm sẽ được thêm vào đây từ cơ sở dữ liệu -->
    </select>
    <div id="revenue-profit-chart" style="height: 350px;"></div>
</div>

<script>
    $(document).ready(function () {
        $.ajax({
            url: '@Url.Action("GetAvailableYears", "Statistical")',
            type: 'GET',
            dataType: 'json',
            success: function (years) {
                var yearSelect = $('#yearSelect');
                years.forEach(function (year) {
                    yearSelect.append($('<option>').val(year).text(year));
                });

                if (years.length > 0) {
                    yearSelect.val(years[0]);
                    fetchRevenueAndProfit(years[0]);
                }
            },
            error: function () {
                alert('Không thể lấy danh sách năm.');
            }
        });

        $('#yearSelect').change(function () {
            var selectedYear = $(this).val();
            fetchRevenueAndProfit(selectedYear);
        });
    });

    function fetchRevenueAndProfit(year) {
        $.ajax({
            url: '@Url.Action("RevenueAndProfit", "Statistical")',
            type: 'GET',
            data: { year: year },
            dataType: 'json',
            success: function (data) {
                var chartData = data.map(item => {
                    return {
                        month: 'Tháng ' + item.Month,
                        revenue: item.Revenue,
                        profit: item.Profit
                    };
                });

                new Morris.Line({
                    element: 'revenue-profit-chart',
                    data: chartData,
                    xkey: 'month',
                    ykeys: ['revenue', 'profit'],
                    labels: ['Doanh thu', 'Lợi nhuận'],
                    lineColors: ['#0b62a4', '#d9534f'],
                    hideHover: 'auto',
                    resize: true,
                    parseTime: false
                });
            },
            error: function () {
                alert('Không thể lấy dữ liệu biểu đồ.');
            }
        });
    }
</script>
