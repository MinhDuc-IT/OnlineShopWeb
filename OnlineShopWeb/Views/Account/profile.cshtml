﻿@{
    ViewBag.Title = "profile";
    Layout = "~/Views/Shared/_LayoutAccount.cshtml";
}

<div class="p_content">
    <div class="pc_header">
        <span class="pch_title">Hồ sơ của tôi</span>
        <span>Quản lý thông tin hồ sơ để bảo mật tài khoản</span>
    </div>
    <div class="pc_main">
        <div class="pcm_info">
            <form id="my-form">
                <table>
                    <tr>
                        <td class="pcm_title">Tên đăng nhập</td>
                        <td class="pcm_property">hoangduc54544</td>
                    </tr>
                    <tr>
                        <td class="pcm_title">Tên</td>
                        <td class="pcm_property">
                            <input name="input_Name" class="input_Name" type="text" />
                        </td>
                    </tr>
                    <tr>
                        <td class="pcm_title">Email</td>
                        <td class="pcm_property">duch52362@gmail.com</td>
                    </tr>
                    <tr>
                        <td class="pcm_title">Số điện thoại</td>
                        <td class="pcm_property">0386941739</td>
                    </tr>
                    <tr>
                        <td class="pcm_title">Giới tính</td>
                        <td class="pcm_property pcm_gender">
                            <input id="Male" name="gender" value="0" type="radio" />
                            <label for="Male">Nam</label>
                            <input id="Female" name="gender" value="1" type="radio" />
                            <label for="Female">Nữ</label>
                            <input id="orther" name="gender" value="2" type="radio" />
                            <label for="orther">Khác</label>
                        </td>
                    </tr>
                    <tr>
                        <td class="pcm_title">Ngày sinh</td>
                        <td class="pcm_property pcm_date">
                            <select class="css_select" id="day"></select>
                            <select class="css_select" id="month"></select>
                            <select class="css_select" id="year"></select>
                        </td>
                    </tr>
                    <tr>
                        <td class="pcm_title"></td>
                        <td id="submitChange" class="pcm_property"><button>Lưu</button></td>
                    </tr>
                </table>
            </form>
        </div>
        <div class="pcm_avatar">
            <img id="prevImage" src="https://static.vecteezy.com/system/resources/previews/005/005/788/non_2x/user-icon-in-trendy-flat-style-isolated-on-grey-background-user-symbol-for-your-web-site-design-logo-app-ui-illustration-eps10-free-vector.jpg" alt="user_avatar" />
            <img id="afterImage" src="https://static.vecteezy.com/system/resources/previews/005/005/788/non_2x/user-icon-in-trendy-flat-style-isolated-on-grey-background-user-symbol-for-your-web-site-design-logo-app-ui-illustration-eps10-free-vector.jpg" alt="user_avatar" />
            <input type="file" onchange="handleUploadImage(event)" id="user_avatar" style="display:none;" />
            <label class="btnUpLoad" for="user_avatar">Chọn Ảnh</label>
            <span>Dụng lượng file tối đa 1 MB</span>
            <span>Định dạng:.JPEG, .PNG</span>
        </div>
    </div>
</div>

<script>
    let file;
    const handleUploadImage = (event) => {
        file = event.target.files[0];
        if (file) {
            const validTypes = ["image/jpeg", "image/png"];
            if (validTypes.includes(file.type)) {
                const maxSize = 1 * 1024 * 1024;
                if (file.size <= maxSize) {
                    const imgElement = document.getElementById("prevImage");
                    imgElement.src = URL.createObjectURL(file);
                } else {
                    alert("File quá lớn! Dung lượng tối đa là 1 MB.");
                }
            } else {
                alert("Chỉ chấp nhận định dạng .JPEG và .PNG.");
            }
        }
    };

    const handleSaveInfo = () => {
        const urlImage = file;
        let form = document.getElementById("my-form");
        let formData = new FormData(form);
        let birthDay = $("#day").val() + "/" + $("#month").val() + "/" + $("#year").val();
        formData.append("urlImage", urlImage);
        formData.append("birthDay", birthDay);

        $.ajax({
            type: "POST",
            url: "/Account/updateProfile",
            data: formData,
            processData: false,
            contentType: false,
            dataType: "json",  
            success: function (response) {
                if (response.success) {  
                    if (response.imageBase64) {
                        const afterImage = document.getElementById("afterImage");
                        afterImage.src = "data:image/png;base64," + response.imageBase64; // Gán ảnh base64 vào `src`
                    }
                } else {
                    alert("Đã có lỗi xảy ra: " + response.message);
                }
            },
            error: function (error) {
                alert("Đã xảy ra lỗi khi lưu thông tin!");
            }
        });

    }

    $(document).ready(function () {
        $("#submitChange").on("click", function (e) {
            e.preventDefault();
            handleSaveInfo();
        })
        let day = new Date().getDate();
        let month = new Date().getMonth() + 1;
        let year = new Date().getFullYear();

        for (let i = 1; i <= 31; i++) {
            $('#day').append(`<option value="${i}" ${i === day ? 'selected' : ''}>${i}</option>`);
        }
        for (let i = 1; i <= 12; i++) {
            $('#month').append(`<option value="${i}" ${i === month ? 'selected' : ''}>${i}</option>`);
        }
        for (let i = year; i >= 1910; i--) {
            $('#year').append(`<option value="${i}" ${i === year ? 'selected' : ''}>${i}</option>`);
        }
    });
</script>